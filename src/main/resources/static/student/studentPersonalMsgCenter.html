<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>学生信息管理中心</title>

    <script src="../js/jquery2.0.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <!--<link href="head.css" rel="stylesheet">-->

    <style>
        table{
            text-align: center;
        }
        div{
            padding-bottom: 10px;
            padding-left: 20px;
            align-content: center;
            padding-top: 10px;
        }
        table{
            padding-bottom: 10px;
            padding-left: 20px;
            align-content: center;
        }
    </style>
</head>
<body style="background-image: url('../img/timg.jpg')">

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">欢迎：
                <span id="user-name-label"></span>
            </a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li><a id="checkout" href="#" onclick="checkout()">退出登录</a></li>
                <li><a href="userPersonalCenter.html">个人中心</a></li>
                <li><a href="studentPersonalMsgCenter.html">学生信息中心</a></li>
                <li><a href="chooseClass.html">选课中心</a></li>
                <!--<li><a href="studentPersonalMsgCenter.html">已选课程列表</a></li>-->
            </ul>
        </div>
    </div>
</nav>

<div>
    <span>学生信息管理中心</span>
</div>

<div id="chooseStudentMsgIfExists">

    <table border="1px" cellspacing="0" >
        <tr>
            <th>id</th>
            <th>学号</th>
            <th>姓名</th>
            <th>年龄</th>
            <th>性别</th>
            <th>专业</th>
            <th>院系</th>
            <th>学校</th>
            <th>更新时间</th>
            <th>
                操作
            </th>
        </tr>
        <tbody id="tr_td">

        </tbody>
    </table>

</div>

<!-- 添加学生信息模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <!--<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                <h4 class="modal-title" id="myModalLabel">添加信息</h4>
            </div>

            <div>
                <span hidden>id：</span>
                <input type="number" id="studentId" value="" hidden>
            </div>

            <div>
                <span>学号：</span>
                <input type="number" id="number" value="">
                <span id="number1" style="color: brown;"></span>
            </div>

            <div>
                <span >姓名：</span>
                <input type="text" id="username">
                <span id="username1" style="color: brown;"></span>
            </div>

            <div>
                <span>年龄：</span>
                <input type="text" id="age">
                <span id="age1" style="color: brown;"></span>
            </div>

            <div>
                <span>性别：</span>
                <input type="text" id="sex">
                <span id="sex1" style="color: brown;"></span>
            </div>

            <div>
                <span>专业：</span>
                <input type="text" id="major">
                <span id="major1" style="color: brown;"></span>
            </div>

            <div>
                <span>院系：</span>
                <input type="text" id="colleage">
                <span id="colleage1" style="color: brown;"></span>
            </div>

            <div>
                <span>学校：</span>
                <input type="text" id="school">
                <span id="school1" style="color: brown;"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addStudentMsg()">添加</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModa" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <!--<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                <h4 class="modal-title" id="myModalLabe">修改学生信息</h4>
            </div>

            <div>
                <span hidden>id：</span>
                <input type="number" id="studentId1" value="" hidden>
            </div>

            <div>
                <span>学号：</span>
                <input type="number" id="studyNumber" value="">
                <span id="studyNumber1" style="color: brown;"></span>
            </div>

            <div>
                <span>姓名：</span>
                <input type="text" id="studentName">
                <span id="studentName1" style="color: brown;"></span>
            </div>

            <div>
                <span>年龄：</span>
                <input type="text" id="studentAge">
                <span id="studentAge1" style="color: brown;"></span>
            </div>

            <div>
                <span>性别：</span>
                <input type="text" id="studentSex">
                <span id="studentSex1" style="color: brown;"></span>
            </div>

            <div>
                <span>专业：</span>
                <input type="text" id="majorIn">
                <span id="majorIn1" style="color: brown;"></span>
            </div>

            <div>
                <span>院系：</span>
                <input type="text" id="studentColleage">
                <span id="studentColleage1" style="color: brown;"></span>
            </div>

            <div>
                <span>学校：</span>
                <input type="text" id="studentSchool">
                <span id="studentSchool1" style="color: brown;"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="updateStudentMsg()">提交更改</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


<div id="ShowButton">

</div>

<script>
    $(function() {

        //从session中获取登陆用户，并显示用户名
        $.ajax({
            type: "GET",
            url: "/user/userMsg",
            dataType: "json", //return dataType: text or json
            data: null,
            contentType: "application/json",
            success: function (data) {
                console.log(data.name);
                // debugger
                $("#user-name-label").html(data.name);

                //根据用户名传入后台，获取登陆的用户的学生信息，如果存在则显示已经存在的学生信息
                /*如果不存在则让该用户添加信息*/
                var html = "";
                $.ajax({
                    type: "POST",
                    url: "/user/crossUserIdFindStudentMsg",
                    datatype: "json",
                    data: JSON.stringify({"name":data.name}),
                    contentType: "application/json",
                    success: function (data1) {

                        if (data1.message == "success"){

                            var id = data1.data.id;
                            var number = data1.data.number;
                            var name = data1.data.name;
                            var age = data1.data.age;
                            var sex = data1.data.sex;
                            var major = data1.data.major;
                            var colleage = data1.data.colleage;
                            var school = data1.data.school;
                            var time = data1.data.updateTime;

                            html += "<tr id='bottom-text'>";
                            html += "<td>";
                            html += id;
                            html += "</td>";

                            html += "<td>";
                            html += number;
                            html += "</td>";

                            html += "<td>";
                            html += name;
                            html += "</td>";

                            html += "<td>";
                            html += age;
                            html += "</td>";

                            html += "<td>";
                            html += sex;
                            html += "</td>";

                            html += "<td>";
                            html += major;
                            html += "</td>";

                            html += "<td>";
                            html += colleage;
                            html += "</td>";

                            html += "<td>";
                            html += school;
                            html += "</td>";

                            html += "<td>";
                            html += time;
                            html += "</td>";

                            html += "<td>";
                            html += "<input type='button' id='updateButton' value='修改' onclick='toUpdate(event)' data-toggle='modal' data-target='#myModa'>";
                            html += "</td>";

                            html += "</tr>";
                            $("#tr_td").html(html);
                        }

                        else if (data1.message == "null"){
                            //开始添加学生信息，
                            divButton = "";
                            divButton += "<span>您还没有添加自己的学生信息,点击添加按钮开始添加学生信息</span>";
                            divButton += "<div><input type='button' data-toggle='modal' data-target='#myModal' value='添加'></div>";
                            $("#ShowButton").html(divButton);
                        }
                        else{
                            alert(data1.data)
                        }
                    }
                })
            }
        });
    });

    /*添加学生信息触发该函数*/
    function addStudentMsg() {

        var number = $("#number").val();
        var username = $("#username").val();
        var age = $("#age").val();
        var sex = $("#sex").val();
        var major = $("#major").val();
        var colleage = $("#colleage").val();
        var school = $("#school").val();

        if(number == ""){
            $("#number1").html("学号不能为空");
            return;
        }

        if(age == ""){
            $("#age1").html("年龄不能为空");
            return;
        }

        if(sex == ""){
            $("#sex1").html("性别不能为空");
            return;
        }

        if(major == ""){
            $("#major1").html("专业不能为空");
            return;
        }

        if(colleage == ""){
            $("#colleage1").html("院系不能为空");
            return;
        }

        if(school == ""){
            $("#school1").html("学校不能为空");
            return;
        }

        $.ajax({
            type: "POST",
            url: "/student/addMsg",
            dataType: "json", //return dataType: text or json
            data : JSON.stringify({"number":number,"name":username,"age":age,"sex":sex,"major":major,"colleage":colleage,"school":school}),
            contentType: "application/json",
            success: function(data) {
                console.log(data);
                if (data.message==="success"){
                    alert("添加成功！");
                    window.location.reload();
                }else {
                    alert(data.message);
                }
            }
        });
    }

    //点击"修改"按钮，触发该函数
    function toUpdate(event) {

        event.target; //获取事件发生的位置
        var id = $(event.target).parents('tr').eq(0).find('td').eq(0).text(); //获取对应的信息的id

        //按照id从后台查询该学生的信息。
        $.ajax({
            type: "GET",
            url: "/student/toUpdate",
            dataType: "json", //return dataType: text or json
            data: {"id":id},
            contentType: "application/json",
            success: function (data) {

                //将从后台查取到的值显示到模态框中
                $("#studentId1").attr("value",data.data.id);
                $("#studyNumber").attr("value",data.data.number);
                $("#studentName").attr("value",data.data.name);
                $("#studentAge").attr("value",data.data.age);
                $("#studentSex").attr("value",data.data.sex);
                $("#majorIn").attr("value",data.data.major);
                $("#studentColleage").attr("value",data.data.colleage);
                $("#studentSchool").attr("value",data.data.school);
            }

        });

    };

    //点击”提交更改“触发的函数
    function updateStudentMsg() {

        var id = $("#studentId1").val();
        var number = $("#studyNumber").val();
        var username = $("#studentName").val();
        var age = $("#studentAge").val();
        var sex = $("#studentSex").val();
        var major = $("#majorIn").val();
        var colleage = $("#studentColleage").val();
        var school = $("#studentSchool").val();

        //更新表记录
        $.ajax({
            type: "POST",
            url: "/student/updateStudentMsg",
            dataType: "json", //return dataType: text or json
            data : JSON.stringify({"id":id,"number":number,"name":username,"age":age,"sex":sex,"major":major,"colleage":colleage,"school":school}),
            contentType: "application/json",
            success: function(data) {
                console.log(data);
                if (data.message==="success"){
                    alert("修改成功！");
                    window.location.reload();
                }else  {
                    alert(data.data);
                }
            }
        });

    };

    /*退出登录的ajax*/
    function checkout() {
        $.ajax({
            type: "GET",
            url: "/user/checkout",
            dataType: "json", //return dataType: text or json
            data: null,
            contentType: "application/json",
            success: function (data) {
                if(data.message=="200"){
                    alert("退出成功，即将跳转回登陆界面");
                    window.location.href = "../student/login.html";
                }else {
                    alert("服务器错误，请联系管理员");
                }
            }
        });
    }
</script>

</body>
</html>